// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User entity (authentication & authorization)
model User {
  id         String   @id // Clerk user ID
  email      String   @unique
  role       Role
  firstName  String?
  lastName   String?
  imageUrl   String?
  
  // Relationship to Staff (optional - managers don't have staff records)
  staff      Staff?
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("users")
}

// Staff entity (core business object)
model Staff {
  id             String   @id @default(cuid())
  name           String   @db.VarChar(100)
  phone          String   @unique @db.VarChar(20)
  skill          Skill    @default(FRONT)
  perEventSalary Decimal  @db.Decimal(10, 2)
  notes          String?  @db.Text
  status         Status   @default(ACTIVE)
  
  // Relationship to User (optional - staff may exist before login account created)
  userId         String?  @unique
  user           User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // 排班關聯
  eventStaff     EventStaff[]
  
  // 可用性行事曆
  availability   StaffAvailability[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([status])
  @@index([name])
  @@index([skill])
  @@map("staff")
}

// Enums
enum Status {
  ACTIVE
  INACTIVE
}

enum Role {
  MANAGER
  STAFF
}

enum Skill {
  FRONT   // 外場
  HOT     // 熱台
  BOTH    // 皆可
}

enum EventType {
  WEDDING     // 婚宴
  YEAREND     // 尾牙
  SPRING      // 春酒
  BIRTHDAY    // 生日宴
  CORPORATE   // 企業活動
  OTHER       // 其他
}

enum EventStatus {
  PENDING       // 待確認
  CONFIRMED     // 已確認
  IN_PROGRESS   // 進行中
  COMPLETED     // 已完成
  CANCELLED     // 已取消
}

enum PaymentMethod {
  TRANSFER      // 匯款
  CASH          // 現金
  HOTEL_PAID    // 民宿代付
  OTHER         // 其他
}

// Venue entity (場地/民宿主檔)
model Venue {
  id          String   @id @default(cuid())
  name        String   @db.VarChar(200)
  address     String?  @db.Text
  contactName String?  @db.VarChar(100)  // 聯絡人
  contactPhone String? @db.VarChar(20)   // 聯絡電話
  equipment   String?  @db.Text          // 設備說明
  notes       String?  @db.Text          // 注意事項
  isActive    Boolean  @default(true)    // 是否啟用
  
  events      Event[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@map("venues")
}

// 員工可用性（行事曆）
model StaffAvailability {
  id        String   @id @default(cuid())
  staffId   String
  staff     Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  date      DateTime @db.Date
  available Boolean  @default(true)      // 當天是否可出勤
  reason    String?  @db.VarChar(200)    // 不可用原因
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([staffId, date])  // 每人每天只有一筆
  @@index([staffId])
  @@index([date])
  @@map("staff_availability")
}

// Event entity (catering event/function)
model Event {
  id             String       @id @default(cuid())
  name           String       @db.VarChar(200)
  date           DateTime     @db.Date
  startTime      String?      @db.VarChar(5)  // HH:mm format
  
  // 場地
  venueId        String?
  venue          Venue?       @relation(fields: [venueId], references: [id])
  location       String       @db.VarChar(200)  // 可手動輸入或從場地帶入
  address        String?      @db.Text
  
  // 訂餐人數
  adultsCount    Int?         // 大人
  childrenCount  Int?         // 小孩
  vegetarianCount Int?        // 素食
  
  // 聯絡資訊
  contactName    String?      @db.VarChar(100)
  contactPhone   String?      @db.VarChar(20)
  
  // 活動類型
  eventType      EventType    @default(OTHER)
  
  // 金額
  totalAmount    Decimal?     @db.Decimal(10, 0)  // 訂單總金額
  
  // 訂金
  depositAmount  Decimal?     @db.Decimal(10, 0)  // 訂金金額
  depositMethod  PaymentMethod?                   // 訂金支付方式
  depositDate    DateTime?    @db.Date            // 訂金支付日期
  
  // 尾款
  balanceAmount  Decimal?     @db.Decimal(10, 0)  // 尾款金額
  balanceMethod  PaymentMethod?                   // 尾款支付方式
  balanceDate    DateTime?    @db.Date            // 尾款支付日期
  
  notes          String?      @db.Text
  status         EventStatus  @default(PENDING)
  
  // 排班人員關聯
  eventStaff     EventStaff[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([date])
  @@index([status])
  @@index([eventType])
  @@index([venueId])
  @@map("events")
}

// 出勤狀態
enum AttendanceStatus {
  SCHEDULED     // 已排班
  CONFIRMED     // 已確認出勤
  ATTENDED      // 已出勤
  LATE          // 遲到
  ABSENT        // 缺勤
  CANCELLED     // 取消
}

// EventStaff entity (活動人員指派 - 中間表)
model EventStaff {
  id               String           @id @default(cuid())
  
  // 關聯
  eventId          String
  event            Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  staffId          String
  staff            Staff            @relation(fields: [staffId], references: [id], onDelete: Cascade)
  
  // 工作資訊
  role             Skill            // 工作角色（使用 Staff 的 Skill enum）
  salary           Decimal          @db.Decimal(10, 0)  // 該場薪資
  
  // 出勤資訊
  attendanceStatus AttendanceStatus @default(SCHEDULED)
  actualHours      Decimal?         @db.Decimal(4, 1)   // 實際工作時數
  adjustedSalary   Decimal?         @db.Decimal(10, 0)  // 調整後薪資
  
  notes            String?          @db.Text
  
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@unique([eventId, staffId])  // 同一活動不可重複指派同一員工
  @@index([eventId])
  @@index([staffId])
  @@index([attendanceStatus])
  @@map("event_staff")
}
